## Requirements ##

<ul>
<li>Docker-compose 1.21.0+</li>
<li>Docker 20.10.1+</li>
<li>5 GB RAM</li>
</ul>

The following procedure has been tested on Debian 10 and Ubuntu LTS 20.04.

## Configuration ##

Get the OpenCVE docker repository:

```
$ git clone https://github.com/opencve/opencve-docker.git
```

Prepare and copy the configuration file from the conf directory:

```
$ cd opencve-docker && cp ./conf/opencve.cfg.example ./conf/opencve.cfg
```

**Note:** In opencve.cfg, update the following keys:
- server_name (use the same port if you changed it in the .env file)
- secret_key (see the Flask [recommandations](https://flask.palletsprojects.com/en/1.1.x/config/#SECRET_KEY))
- smtp_server
- smtp_user & smtp_password if any or leave empty

**Note:** If you want to change the default postgresql password (strongly advised), you can add it in the .env file before the docker-compose build:

```
POSTGRES_PASSWORD=MyStrongPassword42
```

Then don't forget to change it in the opencve.cfg file.

**Note:** You will need a SMTP server to send the notification emails. Its configuration is out of scope of this procedure.

## Initialize the stack ##

Build the OpenCVE image:

```
$ docker-compose build
```

Start everything except the beat:

```
$ docker-compose up -d postgres redis webserver celery_worker
```

We will initialize and import the data inside the database first, before starting the beat to avoid change during the initialization.

The initial import can reach until 3.5 GB RAM, so you need to have 4.5 GB or 5 GB to be safe compare to the OS you use. Afterwards, the worker use very small memory as only the diff is used with the NVD.

In case you don't have 5 GB RAM available and you have disk space, you can use a swap file to do the initial import of CVEs:

```
$ fallocate -l 5G /swapfile
$ chmod 600 /swapfile
$ mkswap /swapfile
$ swapon /swapfile
```

## Initialize the database ##

```
$ docker exec -it webserver opencve upgrade-db
```

## Import the data ##

```
$ docker exec -it webserver opencve import-data
```

When the import is done, you can clean the swapfile if you used it:
```
$ swapoff /swapfile
$ rm /swapfile
```

## Start the beat ##

```
$ docker-compose up -d celery_beat
```

## Create an admin ##

```
$ docker exec -it webserver opencve create-user john john.doe@example.com --admin
Password:
Repeat for confirmation:
[*] User john created.
```


